{% comment %}
  Product Page Template
{% endcomment %}

<div class="product-page section">
  <div class="container">
    <div class="product__grid">
      {%- comment -%} Product Images {%- endcomment -%}
      <div class="product__images">
        <div class="product__main-image product__main-image--zoomable" onclick="openLightbox(0)">
          {% if product.featured_image %}
            <img
              id="product-featured-image"
              src="{{ product.featured_image | image_url: width: 800 }}"
              alt="{{ product.featured_image.alt | escape }}"
              width="800"
              height="800"
              class="product-image-zoom"
            >
            <div class="zoom-hint">
              <svg class="icon icon--sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" fill="currentColor"/>
                <path d="M12 10h-2v2H9v-2H7V9h2V7h1v2h2v1z" fill="currentColor"/>
              </svg>
              Click to enlarge
            </div>
          {% else %}
            {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
          {% endif %}
        </div>

        {% if product.images.size > 1 %}
          <div class="product__thumbnails">
            {% for image in product.images %}
              <button
                class="product__thumbnail {% if forloop.first %}active{% endif %}"
                data-image-id="{{ image.id }}"
                onclick="updateMainImage('{{ image | image_url: width: 800 }}')"
              >
                <img
                  src="{{ image | image_url: width: 150 }}"
                  alt="{{ image.alt | escape }}"
                  width="80"
                  height="80"
                >
              </button>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      {%- comment -%} Product Info {%- endcomment -%}
      <div class="product__info">
        <h1 class="product__title">{{ product.title }}</h1>

        <div class="product__reviews">
          {% render 'review-stars', rating: 5 %}
          <span class="product__review-count">(247 reviews)</span>
        </div>

        <div class="product__price">
          <span class="product__price-amount" id="product-price">
            {{ product.selected_or_first_available_variant.price | money }}
          </span>
          {% if product.selected_or_first_available_variant.compare_at_price > product.selected_or_first_available_variant.price %}
            <span class="product__price-compare">
              {{ product.selected_or_first_available_variant.compare_at_price | money }}
            </span>
          {% endif %}
        </div>

        <div class="product__description">
          {{ product.description }}
        </div>

        {%- comment -%} Product Form {%- endcomment -%}
        <form method="post" action="{{ routes.cart_add_url }}" id="product-form" class="product__form">
          {% if product.has_only_default_variant %}
            <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
          {% else %}
            <div class="product__variants">
              <label class="product__label">{{ product.options_with_values[0].name }}</label>
              <div class="variant-selector">
                {% for variant in product.variants %}
                  <input
                    type="radio"
                    name="id"
                    id="variant-{{ variant.id }}"
                    value="{{ variant.id }}"
                    {% if variant == product.selected_or_first_available_variant %}checked{% endif %}
                    {% unless variant.available %}disabled{% endunless %}
                    class="variant-input"
                    data-price="{{ variant.price }}"
                    data-compare-price="{{ variant.compare_at_price }}"
                  >
                  <label for="variant-{{ variant.id }}" class="variant-label">
                    <span class="variant-title">{{ variant.title }}</span>
                    {% if variant.compare_at_price > variant.price %}
                      <span class="variant-savings badge badge--success">
                        Save {{ variant.compare_at_price | minus: variant.price | money }}
                      </span>
                    {% endif %}
                  </label>
                {% endfor %}
              </div>
            </div>
          {% endif %}

          <div class="product__quantity">
            <label class="product__label">Quantity</label>
            <div class="quantity-selector">
              <button type="button" class="quantity-btn" onclick="updateQuantity(-1)">-</button>
              <input
                type="number"
                name="quantity"
                value="1"
                min="1"
                id="quantity-input"
                class="quantity-value"
              >
              <button type="button" class="quantity-btn" onclick="updateQuantity(1)">+</button>
            </div>
          </div>

          <button
            type="submit"
            name="add"
            class="btn btn--primary btn--lg btn--full"
            data-add-to-cart
            {% unless product.available %}disabled{% endunless %}
          >
            {% if product.available %}
              Add to Cart
            {% else %}
              Sold Out
            {% endif %}
          </button>

          <div class="product__trust">
            {% render 'trust-badges' %}
          </div>
        </form>

        {%- comment -%} Product Details Accordion {%- endcomment -%}
        <div class="product__accordion">
          <details class="accordion-item" open>
            <summary class="accordion-title">
              <span>Features</span>
              <svg class="icon icon--sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z" fill="currentColor"/>
              </svg>
            </summary>
            <div class="accordion-content">
              <ul>
                <li>Electrostatic technology attracts pet hair like a magnet</li>
                <li>Soft, gentle material safe for all pets</li>
                <li>Reusable and easy to clean</li>
                <li>Works on furniture, clothing, and car interiors</li>
              </ul>
            </div>
          </details>

          <details class="accordion-item">
            <summary class="accordion-title">
              <span>Shipping</span>
              <svg class="icon icon--sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z" fill="currentColor"/>
              </svg>
            </summary>
            <div class="accordion-content">
              <p>Free shipping on all orders. Delivery within 5-7 business days.</p>
            </div>
          </details>

          <details class="accordion-item">
            <summary class="accordion-title">
              <span>Returns</span>
              <svg class="icon icon--sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z" fill="currentColor"/>
              </svg>
            </summary>
            <div class="accordion-content">
              <p>30-day money-back guarantee. Not satisfied? Return for a full refund.</p>
            </div>
          </details>
        </div>
      </div>
    </div>
  </div>
</div>

{%- comment -%} Image Lightbox Modal {%- endcomment -%}
<div id="product-lightbox" class="lightbox" onclick="closeLightboxOnBackground(event)">
  <button class="lightbox__close" onclick="closeLightbox()" aria-label="Close lightbox">
    <svg class="icon icon--md" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/>
    </svg>
  </button>

  <button class="lightbox__nav lightbox__nav--prev" onclick="navigateLightbox(-1)" aria-label="Previous image">
    <svg class="icon icon--lg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" fill="currentColor"/>
    </svg>
  </button>

  <button class="lightbox__nav lightbox__nav--next" onclick="navigateLightbox(1)" aria-label="Next image">
    <svg class="icon icon--lg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" fill="currentColor"/>
    </svg>
  </button>

  <div class="lightbox__content">
    <img id="lightbox-image" src="" alt="" class="lightbox__image">
    <div class="lightbox__counter">
      <span id="lightbox-current">1</span> / <span id="lightbox-total">{{ product.images.size }}</span>
    </div>
  </div>
</div>

{%- comment -%} Sticky Add to Cart Bar (Mobile) {%- endcomment -%}
<div class="sticky-atc" id="sticky-atc">
  <div class="container">
    <div class="sticky-atc__content">
      <div class="sticky-atc__info">
        <span class="sticky-atc__title">{{ product.title }}</span>
        <span class="sticky-atc__price" id="sticky-price">{{ product.selected_or_first_available_variant.price | money }}</span>
      </div>
      <button type="submit" form="product-form" class="btn btn--primary">Add to Cart</button>
    </div>
  </div>
</div>

<style>
  .product-page {
    margin-top: 80px;
  }

  .product__grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 4rem;
    align-items: flex-start;
  }

  .product__images {
    position: sticky;
    top: 100px;
  }

  .product__main-image {
    border-radius: 12px;
    overflow: hidden;
    background: var(--color-primary);
    margin-bottom: 1rem;
    position: relative;
    cursor: pointer;
  }

  .product__main-image img {
    width: 100%;
    height: auto;
    display: block;
    transition: transform 0.4s ease;
  }

  /* Image Zoom on Hover (Desktop only) */
  @media (min-width: 969px) {
    .product__main-image--zoomable:hover .product-image-zoom {
      transform: scale(1.15);
    }

    .product__main-image:hover .zoom-hint {
      opacity: 1;
    }
  }

  .zoom-hint {
    position: absolute;
    bottom: 1rem;
    right: 1rem;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
  }

  .zoom-hint .icon {
    fill: white;
  }

  .product__thumbnails {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.75rem;
  }

  .product__thumbnail {
    border: 2px solid transparent;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    background: var(--color-primary);
    padding: 0;
    transition: border-color 0.2s ease;
  }

  .product__thumbnail:hover,
  .product__thumbnail.active {
    border-color: var(--color-secondary);
  }

  .product__thumbnail img {
    width: 100%;
    height: auto;
    display: block;
  }

  .product__title {
    font-size: 2.5rem;
    margin-bottom: 1rem;
  }

  .product__reviews {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .product__review-count {
    font-size: 0.9375rem;
    color: #666;
  }

  .product__price {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .product__price-amount {
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-secondary);
  }

  .product__price-compare {
    font-size: 1.25rem;
    color: #999;
    text-decoration: line-through;
  }

  .product__description {
    font-size: 1rem;
    line-height: 1.7;
    color: #555;
    margin-bottom: 2rem;
  }

  .product__label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.75rem;
  }

  .product__variants {
    margin-bottom: 1.5rem;
  }

  .variant-selector {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .variant-input {
    display: none;
  }

  .variant-label {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    border: 2px solid rgba(0, 0, 0, 0.15);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .variant-label:hover {
    border-color: var(--color-secondary);
  }

  .variant-input:checked + .variant-label {
    border-color: var(--color-secondary);
    background: rgba(45, 80, 22, 0.05);
  }

  .variant-input:disabled + .variant-label {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .variant-title {
    font-weight: 600;
  }

  .product__quantity {
    margin-bottom: 1.5rem;
  }

  .quantity-selector {
    display: flex;
    align-items: center;
    gap: 0;
    width: fit-content;
    border: 2px solid rgba(0, 0, 0, 0.15);
    border-radius: 8px;
    overflow: hidden;
  }

  .quantity-btn {
    width: 48px;
    height: 48px;
    background: white;
    border: none;
    font-size: 1.25rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .quantity-btn:hover {
    background: var(--color-primary);
  }

  .quantity-value {
    width: 60px;
    height: 48px;
    border: none;
    border-left: 1px solid rgba(0, 0, 0, 0.15);
    border-right: 1px solid rgba(0, 0, 0, 0.15);
    text-align: center;
    font-size: 1rem;
    font-weight: 600;
  }

  .product__trust {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  .product__accordion {
    margin-top: 2rem;
  }

  .accordion-item {
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .accordion-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.25rem 0;
    font-weight: 600;
    font-size: 1.125rem;
    cursor: pointer;
    list-style: none;
  }

  .accordion-title::-webkit-details-marker {
    display: none;
  }

  .accordion-title svg {
    transition: transform 0.2s ease;
  }

  details[open] .accordion-title svg {
    transform: rotate(180deg);
  }

  .accordion-content {
    padding-bottom: 1.25rem;
  }

  .accordion-content ul {
    list-style: none;
    padding-left: 0;
  }

  .accordion-content li {
    padding-left: 1.5rem;
    margin-bottom: 0.5rem;
    position: relative;
  }

  .accordion-content li::before {
    content: "âœ“";
    position: absolute;
    left: 0;
    color: var(--color-secondary);
    font-weight: bold;
  }

  /* Sticky Add to Cart */
  .sticky-atc {
    position: fixed;
    bottom: -100px;
    left: 0;
    width: 100%;
    background: white;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
    padding: 1rem 0;
    z-index: 999;
    transition: bottom 0.3s ease;
  }

  .sticky-atc.visible {
    bottom: 0;
  }

  .sticky-atc__content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
  }

  .sticky-atc__info {
    display: flex;
    flex-direction: column;
  }

  .sticky-atc__title {
    font-weight: 600;
    font-size: 0.9375rem;
  }

  .sticky-atc__price {
    font-weight: 700;
    color: var(--color-secondary);
  }

  /* Lightbox Styles */
  .lightbox {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
  }

  .lightbox.active {
    display: flex;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .lightbox__close {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    cursor: pointer;
    z-index: 10001;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .lightbox__close:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: rotate(90deg);
  }

  .lightbox__close .icon {
    fill: white;
  }

  .lightbox__nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.1);
    border: none;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    cursor: pointer;
    z-index: 10001;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .lightbox__nav:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .lightbox__nav .icon {
    fill: white;
  }

  .lightbox__nav--prev {
    left: 2rem;
  }

  .lightbox__nav--next {
    right: 2rem;
  }

  .lightbox__content {
    max-width: 90%;
    max-height: 90%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }

  .lightbox__image {
    max-width: 100%;
    max-height: calc(90vh - 60px);
    object-fit: contain;
    border-radius: 8px;
  }

  .lightbox__counter {
    color: white;
    font-size: 1rem;
    font-weight: 600;
    background: rgba(0, 0, 0, 0.5);
    padding: 0.5rem 1rem;
    border-radius: 20px;
  }

  @media (max-width: 968px) {
    .product__grid {
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    .product__images {
      position: static;
    }

    .product__title {
      font-size: 2rem;
    }

    /* Lightbox mobile adjustments */
    .lightbox__nav {
      width: 44px;
      height: 44px;
    }

    .lightbox__nav--prev {
      left: 0.5rem;
    }

    .lightbox__nav--next {
      right: 0.5rem;
    }

    .lightbox__close {
      top: 1rem;
      right: 1rem;
      width: 44px;
      height: 44px;
    }

    .zoom-hint {
      display: none; /* Hide zoom hint on mobile */
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .product__main-image img,
    .lightbox {
      animation: none;
      transition: none;
    }

    .product__main-image--zoomable:hover .product-image-zoom {
      transform: none;
    }
  }
</style>

<script>
  // Product images array for lightbox
  const productImages = [
    {% for image in product.images %}
      {
        url: "{{ image | image_url: width: 1600 }}",
        alt: "{{ image.alt | escape }}"
      }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ];

  let currentLightboxIndex = 0;

  // Update main image
  function updateMainImage(imageUrl) {
    document.getElementById('product-featured-image').src = imageUrl;

    // Update active thumbnail
    document.querySelectorAll('.product__thumbnail').forEach(thumb => {
      thumb.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
  }

  // Update quantity
  function updateQuantity(change) {
    const input = document.getElementById('quantity-input');
    const newValue = parseInt(input.value) + change;
    if (newValue >= 1) {
      input.value = newValue;
    }
  }

  // Lightbox functions
  function openLightbox(index) {
    currentLightboxIndex = index;
    const lightbox = document.getElementById('product-lightbox');
    const lightboxImage = document.getElementById('lightbox-image');
    const currentCounter = document.getElementById('lightbox-current');

    lightboxImage.src = productImages[index].url;
    lightboxImage.alt = productImages[index].alt;
    currentCounter.textContent = index + 1;

    lightbox.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  function closeLightbox() {
    const lightbox = document.getElementById('product-lightbox');
    lightbox.classList.remove('active');
    document.body.style.overflow = '';
  }

  function closeLightboxOnBackground(event) {
    if (event.target.id === 'product-lightbox') {
      closeLightbox();
    }
  }

  function navigateLightbox(direction) {
    currentLightboxIndex += direction;

    // Loop around
    if (currentLightboxIndex < 0) {
      currentLightboxIndex = productImages.length - 1;
    } else if (currentLightboxIndex >= productImages.length) {
      currentLightboxIndex = 0;
    }

    const lightboxImage = document.getElementById('lightbox-image');
    const currentCounter = document.getElementById('lightbox-current');

    lightboxImage.src = productImages[currentLightboxIndex].url;
    lightboxImage.alt = productImages[currentLightboxIndex].alt;
    currentCounter.textContent = currentLightboxIndex + 1;
  }

  // Keyboard navigation for lightbox
  document.addEventListener('keydown', (e) => {
    const lightbox = document.getElementById('product-lightbox');
    if (!lightbox.classList.contains('active')) return;

    if (e.key === 'Escape') {
      closeLightbox();
    } else if (e.key === 'ArrowLeft') {
      navigateLightbox(-1);
    } else if (e.key === 'ArrowRight') {
      navigateLightbox(1);
    }
  });

  // Update price on variant change
  document.querySelectorAll('.variant-input').forEach(input => {
    input.addEventListener('change', function() {
      const price = this.dataset.price;
      const comparePrice = this.dataset.comparePrice;

      // Update price display
      document.getElementById('product-price').textContent = formatMoney(price);
      document.getElementById('sticky-price').textContent = formatMoney(price);
    });
  });

  // Sticky ATC on scroll
  const stickyAtc = document.getElementById('sticky-atc');
  let lastScroll = 0;

  window.addEventListener('scroll', () => {
    const productInfo = document.querySelector('.product__info');
    if (!productInfo) return;

    const productBottom = productInfo.offsetTop + productInfo.offsetHeight;
    const scrollPosition = window.scrollY + window.innerHeight;

    if (window.innerWidth < 968 && scrollPosition > productBottom && window.scrollY > lastScroll) {
      stickyAtc.classList.add('visible');
    } else {
      stickyAtc.classList.remove('visible');
    }

    lastScroll = window.scrollY;
  });

  // Format money helper
  function formatMoney(cents) {
    const amount = (cents / 100).toFixed(2);
    return window.ShedAway.settings.moneyFormat.replace('{{amount}}', amount);
  }
</script>
